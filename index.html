<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comparativo de PreÃ§os - Market4You vs Seven vs Flash</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        #fileInput {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .filter-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-card {
            text-align: center;
        }
        
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .kpi-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .market-color { color: #ef4444; }
        .seven-color { color: #22c55e; }
        .flash-color { color: #3b82f6; }
        .economia { color: #10b981; }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-market {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-seven {
            background: #dcfce7;
            color: #15803d;
        }
        
        .badge-flash {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Comparativo de PreÃ§os: Market4You vs Seven vs Flash</h1>
        
        <div class="upload-section">
            <h3>Carregue a planilha de comparativo de preÃ§os</h3>
            <p style="margin: 10px 0; color: #666;">Selecione o arquivo Excel (.xlsx) com os dados</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                ðŸ“‚ Selecionar Arquivo
            </button>
            <p id="fileName" style="margin-top: 10px; color: #666;"></p>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="categoryFilter">Filtrar por Categoria:</label>
                    <select id="categoryFilter">
                        <option value="">Todas as Categorias</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="searchFilter">Buscar Produto:</label>
                    <input type="text" id="searchFilter" placeholder="Digite o nome do produto...">
                </div>
                <div class="filter-item">
                    <label for="priceFilter">Mostrar apenas:</label>
                    <select id="priceFilter">
                        <option value="">Todos os produtos</option>
                        <option value="Market4You">Mais baratos no Market4You</option>
                        <option value="Seven">Mais baratos no Seven</option>
                        <option value="Flash">Mais baratos no Flash</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="card kpi-card">
                <div class="kpi-label">Total de Produtos</div>
                <div class="kpi-value" style="color: #6366f1" id="totalProdutos">0</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Mais Baratos Market4You</div>
                <div class="kpi-value market-color" id="marketMelhor">0</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Mais Baratos Seven</div>
                <div class="kpi-value seven-color" id="sevenMelhor">0</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-label">Mais Baratos Flash</div>
                <div class="kpi-value flash-color" id="flashMelhor">0</div>
            </div>
        </div>
        
        <div class="card hidden" id="economiaCard">
            <h3>ðŸ’° Economia MÃ¡xima PossÃ­vel</h3>
            <div style="text-align: center; padding: 20px;">
                <div class="kpi-value economia" id="economiaMaxima">R$ 0</div>
                <p style="color: #666; margin-top: 10px;">Comprando sempre o produto mais barato entre os trÃªs mercados</p>
            </div>
        </div>
        
        <div class="dashboard-grid" id="chartsGrid">
            <div class="card">
                <h3>DistribuiÃ§Ã£o de Melhores PreÃ§os</h3>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Comparativo por Categoria</h3>
                <div class="chart-container">
                    <canvas id="categoriaChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card hidden" id="topEconomiaCard">
            <h3>Top 15 Maiores Economias</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="topEconomiaChart"></canvas>
            </div>
        </div>
        
        <div class="card hidden" id="tableCard">
            <h3>Tabela Detalhada de Produtos</h3>
            <div class="table-container">
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Produto</th>
                            <th>Market4You</th>
                            <th>Seven</th>
                            <th>Flash</th>
                            <th>Melhor PreÃ§o</th>
                            <th>Economia</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        let charts = {};
        
        // Processar upload do arquivo
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = `Arquivo selecionado: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    processData(jsonData);
                } catch (error) {
                    alert('Erro ao processar arquivo. Verifique se Ã© um arquivo Excel vÃ¡lido.');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        function processData(rawData) {
            allData = [];
            
            rawData.forEach(row => {
                const market = parseFloat(row['PreÃ§o Market4You (R$)']) || 0;
                const seven = parseFloat(row['PreÃ§o Seven (R$)']) || 0;
                const flash = parseFloat(row['PreÃ§o Flash Home (R$)']) || 0;
                
                // Determinar melhor preÃ§o
                let melhor = '';
                let menor = Infinity;
                
                if (market > 0 && market < menor) {
                    melhor = 'Market4You';
                    menor = market;
                }
                if (seven > 0 && seven < menor) {
                    melhor = 'Seven';
                    menor = seven;
                }
                if (flash > 0 && flash < menor) {
                    melhor = 'Flash';
                    menor = flash;
                }
                
                // Calcular economia
                const precos = [market, seven, flash].filter(p => p > 0);
                const economia = precos.length > 1 ? Math.max(...precos) - Math.min(...precos) : 0;
                
                allData.push({
                    categoria: row['Categoria'],
                    produto: row['DescriÃ§Ã£o do Produto'],
                    market: market,
                    seven: seven,
                    flash: flash,
                    melhor: melhor,
                    economia: economia
                });
            });
            
            filteredData = [...allData];
            
            // Mostrar elementos do dashboard
            document.querySelector('.upload-section').style.display = 'none';
            document.querySelector('.filters').style.display = 'block';
            document.querySelectorAll('.dashboard-grid').forEach(el => el.style.display = 'grid');
            document.querySelectorAll('.card.hidden').forEach(el => el.classList.remove('hidden'));
            
            populateCategoryFilter();
            updateDashboard();
        }
        
        function populateCategoryFilter() {
            const categories = [...new Set(allData.map(p => p.categoria))].sort();
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">Todas as Categorias</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }
        
        function updateDashboard() {
            updateKPIs();
            updateDistributionChart();
            updateCategoriaChart();
            updateTopEconomiaChart();
            updateTable();
        }
        
        function updateKPIs() {
            const totalProdutos = filteredData.length;
            const marketMelhor = filteredData.filter(p => p.melhor === 'Market4You').length;
            const sevenMelhor = filteredData.filter(p => p.melhor === 'Seven').length;
            const flashMelhor = filteredData.filter(p => p.melhor === 'Flash').length;
            
            const economiaMaxima = filteredData.reduce((sum, p) => sum + p.economia, 0);
            
            document.getElementById('totalProdutos').textContent = totalProdutos;
            document.getElementById('marketMelhor').textContent = marketMelhor;
            document.getElementById('sevenMelhor').textContent = sevenMelhor;
            document.getElementById('flashMelhor').textContent = flashMelhor;
            document.getElementById('economiaMaxima').textContent = `R$ ${economiaMaxima.toFixed(2)}`;
        }
        
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const marketCount = filteredData.filter(p => p.melhor === 'Market4You').length;
            const sevenCount = filteredData.filter(p => p.melhor === 'Seven').length;
            const flashCount = filteredData.filter(p => p.melhor === 'Flash').length;
            
            if (charts.distribution) charts.distribution.destroy();
            
            charts.distribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Market4You', 'Seven', 'Flash'],
                    datasets: [{
                        data: [marketCount, sevenCount, flashCount],
                        backgroundColor: ['#ef4444', '#22c55e', '#3b82f6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / filteredData.length) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} produtos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateCategoriaChart() {
            const categorias = {};
            filteredData.forEach(p => {
                if (!categorias[p.categoria]) {
                    categorias[p.categoria] = { market: 0, seven: 0, flash: 0 };
                }
                if (p.melhor === 'Market4You') categorias[p.categoria].market++;
                else if (p.melhor === 'Seven') categorias[p.categoria].seven++;
                else if (p.melhor === 'Flash') categorias[p.categoria].flash++;
            });
            
            const ctx = document.getElementById('categoriaChart').getContext('2d');
            if (charts.categoria) charts.categoria.destroy();
            
            charts.categoria = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [
                        { label: 'Market4You', data: Object.values(categorias).map(c => c.market), backgroundColor: '#ef4444' },
                        { label: 'Seven', data: Object.values(categorias).map(c => c.seven), backgroundColor: '#22c55e' },
                        { label: 'Flash', data: Object.values(categorias).map(c => c.flash), backgroundColor: '#3b82f6' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } },
                        y: { stacked: true }
                    }
                }
            });
        }
        
        function updateTopEconomiaChart() {
            const topEconomias = filteredData
                .filter(p => p.economia > 0)
                .sort((a, b) => b.economia - a.economia)
                .slice(0, 15);
            
            const ctx = document.getElementById('topEconomiaChart').getContext('2d');
            if (charts.topEconomia) charts.topEconomia.destroy();
            
            charts.topEconomia = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topEconomias.map(p => p.produto.substring(0, 35)),
                    datasets: [{
                        label: 'Economia (R$)',
                        data: topEconomias.map(p => p.economia),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return 'R$ ' + value.toFixed(2); } }
                        }
                    }
                }
            });
        }
        
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const sortedData = [...filteredData].sort((a, b) => b.economia - a.economia);
            
            sortedData.forEach(produto => {
                const row = document.createElement('tr');
                
                let badgeClass = '';
                if (produto.melhor === 'Market4You') badgeClass = 'badge-market';
                else if (produto.melhor === 'Seven') badgeClass = 'badge-seven';
                else badgeClass = 'badge-flash';
                
                row.innerHTML = `
                    <td>${produto.categoria}</td>
                    <td>${produto.produto}</td>
                    <td>R$ ${produto.market.toFixed(2)}</td>
                    <td>${produto.seven > 0 ? 'R$ ' + produto.seven.toFixed(2) : '-'}</td>
                    <td>${produto.flash > 0 ? 'R$ ' + produto.flash.toFixed(2) : '-'}</td>
                    <td><span class="badge ${badgeClass}">${produto.melhor}</span></td>
                    <td style="color: #10b981; font-weight: bold;">
                        ${produto.economia > 0 ? 'R$ ' + produto.economia.toFixed(2) : '-'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Event Listeners
        document.getElementById('categoryFilter').addEventListener('change', filterData);
        document.getElementById('searchFilter').addEventListener('input', filterData);
        document.getElementById('priceFilter').addEventListener('change', filterData);
        
        function filterData() {
            const category = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const priceFilter = document.getElementById('priceFilter').value;
            
            filteredData = allData.filter(produto => {
                let pass = true;
                
                if (category && produto.categoria !== category) pass = false;
                if (search && !produto.produto.toLowerCase().includes(search)) pass = false;
                if (priceFilter && produto.melhor !== priceFilter) pass = false;
                
                return pass;
            });
            
            updateDashboard();
        }
    </script>
</body>
</html>